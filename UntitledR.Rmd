```{r}
library(r5r)
library(sf)
library(dplyr)
library(data.table)
library(ggplot2)
library(tmap)
library(tidyverse)
library(stringr)
library(janitor)


```

```{r}
options(java.parameters = "-Xmx5G")
```



```{r}

gpk_file <- "Data/poi-school.gpkg"
schools <- st_read(gpk_file)

london_boroughs <- st_read("Data/london_borough/London_Borough_Excluding_MHW.shp")


current_crs <- st_crs(schools)
# trans to WGS 84
if (current_crs != 4326) {
  schools <- st_transform(schools, crs = 4326)
}
coords <- st_coordinates(schools)

# add coordinates
schools$lon <- coords[, "X"]
schools$lat <- coords[, "Y"]

schools <- st_drop_geometry(schools)

schools <- schools %>% rename(id = ref_no)

```


```{r}
# save as .csv
write.csv(schools, "Data/location/poi-school.csv", row.names = FALSE)

```



```{r}
school_sf <- st_as_sf(schools, coords = c("lon", "lat"), crs = 4326)

london_boroughs <- st_transform(london_boroughs, st_crs(school_sf))
school_within_boroughs <- school_sf[london_boroughs, ]


```

```{r}
orgpoints <- fread(file.path("Data/location/HexGrid_1km.csv"))
#destpoints <- fread(file.path("Data/location/poi-school.csv"))

orgpoints_sf <- st_as_sf(orgpoints, coords = c("lon", "lat"), crs = 4326)
orgpoints_within_boroughs <- orgpoints_sf[london_boroughs, ]

destpoints <- school_within_boroughs

tmap_mode("plot")
tm_shape(london_boroughs) +
  tm_polygons(col = NA, alpha = 0.5) +
tm_shape(destpoints) +
  tm_dots(col = "blue")
```

```{r}
osm_file <- "Data/greater-london-latest.osm.pbf"
gtfs_file <- "Data/improved-gtfs-london-dft.zip"

# set up r5r
r5r_core <- setup_r5(data_path = "Data")

```


```{r}
#primary 
filtered_destpoints <- destpoints %>%
  filter(classname == "First, Primary and Infant Schools")

#私人
private_destpoints <- destpoints %>%
  filter(classname == "Independent and Preparatory Schools")

#secondary
secondary_destpoints <- destpoints %>%
  filter(classname == "Broad Age Range and Secondary State Schools")

```


##模版
```{r}
mode <- c("WALK", "TRANSIT")
max_walk_time <- 15 # in minutes
travel_time_cutoff <- 30 # in minutes
departure_datetime <- as.POSIXct("20-06-2024 08:00:00", format = "%d-%m-%Y %H:%M:%S")
time_window <- 15 # in minutes
percentiles <- 50

travel_times <- accessibility(r5r_core,
                                   origins = orgpoints_within_boroughs,
                                   destinations = filtered_destpoints,
                                   mode = mode,
                                  opportunities_colnames = c("pos_accuracy"),
                                  decay_function = "step",
                                  cutoffs = travel_time_cutoff,
                                  departure_datetime = departure_datetime,
                                  max_walk_time = max_walk_time,
                                  time_window = time_window,
                                  percentiles = percentiles,
                                  progress = TRUE)
```


```{r}
coordinates <- st_coordinates(orgpoints_within_boroughs)

orgpoints_within_boroughs_lon_lat <- orgpoints_within_boroughs
orgpoints_within_boroughs_lon_lat$lon <- coordinates[, "X"]
orgpoints_within_boroughs_lon_lat$lat <- coordinates[, "Y"]

orgpoints_within_boroughs_lon_lat <- st_drop_geometry(orgpoints_within_boroughs_lon_lat)


travel_times$id <- as.numeric(travel_times$id)
merged_travel_times <- left_join(travel_times, orgpoints_within_boroughs_lon_lat[, c("id", "lon", "lat", "Population_sum")], by = "id")
merged_travel_times_sf <- st_as_sf(merged_travel_times, coords = c("lon", "lat"), crs = 4326)


```



```{r}
# Draw a base map of London Boroughs and overlay point data from merged_data
# Draw the map and overlay the point data from merged_data
ggplot() +
  geom_sf(data = london_boroughs, fill = "white", color = "black") +  # 绘制伦敦区
  geom_sf(data = merged_travel_times_sf, aes(color = accessibility), alpha = 0.7) +  # 叠加点数据
  scale_color_gradientn(
    colors = c("lightgray", "pink", "orange", "yellow", "deeppink", "purple", "red"), 
    values = scales::rescale(c(0, 5, 10, 20, 50, 80, 120, 150)), 
    limits = c(0, 150), 
    breaks = c(0, 5, 10, 20, 50, 80, 120, 150),
    labels = c("0", "5", "10", "20", "50", "80", "120", "150")
  ) +    
  labs(title = "Accessibility Mapped onto London Boroughs",
       color = "Accessibility") +
  theme_minimal()
```


```{r}
# 按accessibility分组，并累加Population_sum
grouped_data <- merged_travel_times %>%
  group_by(accessibility) %>%
  summarize(total_population = sum(Population_sum, na.rm = TRUE))

# 绘制折线图
ggplot(grouped_data, aes(x = accessibility, y = total_population)) +
  geom_line() +
  geom_point() +
  labs(title = "总人口数量与可达性的关系",
       x = "可达性 (accessibility)",
       y = "总人口数量 (total_population)") +
  theme_minimal()
```

#正式开始！！！！！！
Primary: 13min walk / car
Secondary: 25min walk / car / walk+bus 


##primary 13min walk
```{r}
mode_walk <- c("WALK")
max_walk_time <- 13 # in minutes
travel_time_cutoff <- 13 # in minutes
departure_datetime <- as.POSIXct("20-06-2024 08:00:00", format = "%d-%m-%Y %H:%M:%S")
time_window <- 13 # in minutes
percentiles <- 50

travel_times_primary <- accessibility(r5r_core,
                                   origins = orgpoints_within_boroughs,
                                   destinations = filtered_destpoints,
                                   mode = mode_walk,
                                  opportunities_colnames = c("pos_accuracy"),
                                  decay_function = "step",
                                  cutoffs = travel_time_cutoff,
                                  departure_datetime = departure_datetime,
                                  max_walk_time = max_walk_time,
                                  time_window = time_window,
                                  percentiles = percentiles,
                                  progress = TRUE)
```

```{r}
travel_times_primary$id <- as.numeric(travel_times_primary$id)
merged_travel_times_primary <- left_join(travel_times_primary, orgpoints_within_boroughs_lon_lat[, c("id", "lon", "lat", "Population_sum")], by = "id")
merged_travel_times_primary_sf <- st_as_sf(merged_travel_times_primary, coords = c("lon", "lat"), crs = 4326)

ggplot() +
  geom_sf(data = london_boroughs, fill = "white", color = "black") +  # 绘制伦敦区
  geom_sf(data = merged_travel_times_primary_sf, aes(color = accessibility), alpha = 0.7) +  # 叠加点数据
  scale_color_gradientn(
    colors = c("lightgray", "pink", "orange", "yellow", "deeppink", "purple"), 
    values = scales::rescale(c(0, 1, 2, 3, 4, 5, 6)), 
    limits = c(0, 6), 
    breaks = c(0, 1, 2, 3, 4, 5, 6),
    labels = c("0", "1", "2", "3", "4", "5", "6")
  ) +    
  labs(title = "Primary School Accessibility by walk in London",
       color = "Accessibility") +
  theme_minimal()
```


##primary 13min car
```{r}
mode_car <- c("CAR")
max_walk_time <- 13 # in minutes
travel_time_cutoff <- 13 # in minutes
departure_datetime <- as.POSIXct("20-06-2024 08:00:00", format = "%d-%m-%Y %H:%M:%S")
time_window <- 13 # in minutes
percentiles <- 50

travel_times_primary_car <- accessibility(r5r_core,
                                   origins = orgpoints_within_boroughs,
                                   destinations = filtered_destpoints,
                                   mode = mode_car,
                                  opportunities_colnames = c("pos_accuracy"),
                                  decay_function = "step",
                                  cutoffs = travel_time_cutoff,
                                  departure_datetime = departure_datetime,
                                  max_walk_time = max_walk_time,
                                  time_window = time_window,
                                  percentiles = percentiles,
                                  progress = TRUE)
```

```{r}
travel_times_primary_car$id <- as.numeric(travel_times_primary$id)
merged_travel_times_primary_car <- left_join(travel_times_primary_car, orgpoints_within_boroughs_lon_lat[, c("id", "lon", "lat", "Population_sum")], by = "id")
merged_travel_times_primary_car_sf <- st_as_sf(merged_travel_times_primary_car, coords = c("lon", "lat"), crs = 4326)

ggplot() +
  geom_sf(data = london_boroughs, fill = "white", color = "black") +  # 绘制伦敦区
  geom_sf(data = merged_travel_times_primary_car_sf, aes(color = accessibility), alpha = 0.7) +  # 叠加点数据
  scale_color_gradientn(
    colors = c("lightgray", "pink", "orange", "yellow", "deeppink", "purple", "red"), 
    values = scales::rescale(c(0, 5, 20, 50, 100, 120, 140, 150)), 
    limits = c(0, 150), 
    breaks = c(0, 5, 20, 50, 100, 120, 140, 150),
    labels = c("0", "5", "20", "50", "100", "120", "140", "150")
  ) +   
  labs(title = "Primary School Accessibility by car in London",
       color = "Accessibility") +
  theme_minimal()
```


##secondary 25min walk
```{r}
mode_walk <- c("WALK")
max_walk_time_25 <- 25 # in minutes
travel_time_cutoff_25 <- 25 # in minutes
departure_datetime <- as.POSIXct("20-06-2024 08:00:00", format = "%d-%m-%Y %H:%M:%S")
time_window_25 <- 25 # in minutes
percentiles <- 50

travel_times_secondary_walk <- accessibility(r5r_core,
                                   origins = orgpoints_within_boroughs,
                                   destinations = secondary_destpoints,
                                   mode = mode_walk,
                                  opportunities_colnames = c("pos_accuracy"),
                                  decay_function = "step",
                                  cutoffs = travel_time_cutoff_25,
                                  departure_datetime = departure_datetime,
                                  max_walk_time = max_walk_time_25,
                                  time_window = time_window_25,
                                  percentiles = percentiles,
                                  progress = TRUE)
```

```{r}
travel_times_secondary_walk$id <- as.numeric(travel_times_secondary_walk$id)
merged_travel_times_secondary_walk <- left_join(travel_times_secondary_walk, orgpoints_within_boroughs_lon_lat[, c("id", "lon", "lat", "Population_sum")], by = "id")
merged_travel_times_secondary_walk_sf <- st_as_sf(merged_travel_times_secondary_walk, coords = c("lon", "lat"), crs = 4326)

ggplot() +
  geom_sf(data = london_boroughs, fill = "white", color = "black") +  # 绘制伦敦区
  geom_sf(data = merged_travel_times_secondary_walk_sf, aes(color = accessibility), alpha = 0.7) +  # 叠加点数据
  scale_color_gradientn(
    colors = c("lightgray", "pink", "orange", "yellow", "deeppink", "purple"), 
    values = scales::rescale(c(0, 1, 2, 3, 5, 7, 9)), 
    limits = c(0, 9), 
    breaks = c(0, 1, 2, 3, 5, 7, 9),
    labels = c("0", "1", "2", "3", "5", "7", "9")
  ) +    
  labs(title = "Secondary School Accessibility by walk in London",
       color = "Accessibility") +
  theme_minimal()
```


##secondary 25min car
```{r}
mode_car <- c("CAR")
max_walk_time_25 <- 25 # in minutes
travel_time_cutoff_25 <- 25 # in minutes
departure_datetime <- as.POSIXct("20-06-2024 08:00:00", format = "%d-%m-%Y %H:%M:%S")
time_window_25 <- 25 # in minutes
percentiles <- 50

travel_times_secondary_car <- accessibility(r5r_core,
                                   origins = orgpoints_within_boroughs,
                                   destinations = secondary_destpoints,
                                   mode = mode_car,
                                  opportunities_colnames = c("pos_accuracy"),
                                  decay_function = "step",
                                  cutoffs = travel_time_cutoff_25,
                                  departure_datetime = departure_datetime,
                                  max_walk_time = max_walk_time_25,
                                  time_window = time_window_25,
                                  percentiles = percentiles,
                                  progress = TRUE)
```

```{r}
travel_times_secondary_car$id <- as.numeric(travel_times_secondary_car$id)
merged_travel_times_secondary_car <- left_join(travel_times_secondary_car, orgpoints_within_boroughs_lon_lat[, c("id", "lon", "lat", "Population_sum")], by = "id")
merged_travel_times_secondary_car_sf <- st_as_sf(merged_travel_times_secondary_car, coords = c("lon", "lat"), crs = 4326)

ggplot() +
  geom_sf(data = london_boroughs, fill = "white", color = "black") +  # 绘制伦敦区
  geom_sf(data = merged_travel_times_secondary_car_sf, aes(color = accessibility), alpha = 0.7) +  # 叠加点数据
  scale_color_gradientn(
    colors = c("lightgray", "pink", "orange", "yellow", "deeppink", "purple", "red"), 
    values = scales::rescale(c(0, 10, 20, 50, 100, 130, 160, 190)), 
    limits = c(0, 190), 
    breaks = c(0, 10, 20, 50, 100, 130, 160, 190),
    labels = c("0", "10", "20", "50", "100", "130", "160", "190")
  ) +   
  labs(title = "Secondary School Accessibility by car in London",
       color = "Accessibility") +
  theme_minimal()
```


##secondary 25min walk+bus
```{r}
mode_walk_bus <- c("WALK", "BUS")
max_walk_time_25 <- 25 # in minutes
travel_time_cutoff_25 <- 25 # in minutes
departure_datetime <- as.POSIXct("20-06-2024 08:00:00", format = "%d-%m-%Y %H:%M:%S")
time_window_25 <- 25 # in minutes
percentiles <- 50

travel_times_secondary_walk_bus <- accessibility(r5r_core,
                                   origins = orgpoints_within_boroughs,
                                   destinations = secondary_destpoints,
                                   mode = mode_walk_bus,
                                  opportunities_colnames = c("pos_accuracy"),
                                  decay_function = "step",
                                  cutoffs = travel_time_cutoff_25,
                                  departure_datetime = departure_datetime,
                                  max_walk_time = max_walk_time_25,
                                  time_window = time_window_25,
                                  percentiles = percentiles,
                                  progress = TRUE)
```

```{r}
travel_times_secondary_walk_bus$id <- as.numeric(travel_times_secondary_walk_bus$id)
merged_travel_times_secondary_walk_bus <- left_join(travel_times_secondary_walk_bus, orgpoints_within_boroughs_lon_lat[, c("id", "lon", "lat", "Population_sum")], by = "id")
merged_travel_times_secondary_walk_bus_sf <- st_as_sf(merged_travel_times_secondary_walk_bus, coords = c("lon", "lat"), crs = 4326)

ggplot() +
  geom_sf(data = london_boroughs, fill = "white", color = "black") +  # 绘制伦敦区
  geom_sf(data = merged_travel_times_secondary_walk_bus_sf, aes(color = accessibility), alpha = 0.7) +  # 叠加点数据
  scale_color_gradientn(
    colors = c("lightgray", "pink", "orange", "yellow", "deeppink", "purple"), 
    values = scales::rescale(c(0, 1, 3, 5, 7, 9, 15)), 
    limits = c(0, 15), 
    breaks = c(0, 1, 3, 5, 7, 9, 15),
    labels = c("0", "1", "3", "5", "7", "9", "15")
  ) +    
  labs(title = "Secondary School Accessibility by walk and bus in London",
       color = "Accessibility") +
  theme_minimal()
```



##private 13min walk
```{r}
mode_walk <- c("WALK")
max_walk_time <- 13 # in minutes
travel_time_cutoff <- 13 # in minutes
departure_datetime <- as.POSIXct("20-06-2024 08:00:00", format = "%d-%m-%Y %H:%M:%S")
time_window <- 13 # in minutes
percentiles <- 50

travel_times_private <- accessibility(r5r_core,
                                   origins = orgpoints_within_boroughs,
                                   destinations = private_destpoints,
                                   mode = mode_walk,
                                  opportunities_colnames = c("pos_accuracy"),
                                  decay_function = "step",
                                  cutoffs = travel_time_cutoff,
                                  departure_datetime = departure_datetime,
                                  max_walk_time = max_walk_time,
                                  time_window = time_window,
                                  percentiles = percentiles,
                                  progress = TRUE)


```
```{r}
travel_times_private$id <- as.numeric(travel_times_private$id)
merged_travel_times_private <- left_join(travel_times_private, orgpoints_within_boroughs_lon_lat[, c("id", "lon", "lat", "Population_sum")], by = "id")
merged_travel_times_private_sf <- st_as_sf(merged_travel_times_private, coords = c("lon", "lat"), crs = 4326)

ggplot() +
  geom_sf(data = london_boroughs, fill = "white", color = "black") +  # 绘制伦敦区
  geom_sf(data = merged_travel_times_private_sf, aes(color = accessibility), alpha = 0.7) +  # 叠加点数据
  scale_color_gradientn(
    colors = c("lightgray", "pink", "orange", "yellow", "deeppink", "purple"), 
    values = scales::rescale(c(0, 1, 2, 3, 4, 6, 9)), 
    limits = c(0, 9), 
    breaks = c(0, 1, 2, 3, 4, 6, 9),
    labels = c("0", "1", "2", "3", "4", "6", "9")
  ) +    
  labs(title = "private schools' Accessibility by walk in London",
       color = "Accessibility") +
  theme_minimal()
```




画个折线图(感觉画在公立学校更有意义)
```{r}

# 按accessibility分组，并累加Population_sum
grouped_data <- merged_travel_times_private_sf %>%
  group_by(accessibility) %>%
  summarize(total_population = sum(Population_sum, na.rm = TRUE))

# 绘制折线图
ggplot(grouped_data, aes(x = accessibility, y = total_population)) +
  geom_line() +
  geom_point() +
  labs(title = "总人口数量与可达性的关系",
       x = "可达性 (private school accessibility)",
       y = "总人口数量 (total_population)") +
  theme_minimal()
```

## private school 30分钟  car

私立学校会选择更私人的出行方式，换成car（car的分割得增加，图错了），且该校学生对出行时间的要求更加严格，

```{r}


```

## private school 30反正 步行
可能是因为上一张图中可达性好的地方公共交通比较便利，因此可达性好，但对于高峰期的伦敦市区来说，car比地铁等公共交通更容易堵。试试走路上学
```{r}
mode2 <- c("WALK")

travel_times_private <- accessibility(r5r_core,
                                   origins = orgpoints_within_boroughs,
                                   destinations = private_destpoints,
                                   mode = mode2,
                                  opportunities_colnames = c("pos_accuracy"),
                                  decay_function = "step",
                                  cutoffs = travel_time_cutoff,
                                  departure_datetime = departure_datetime,
                                  max_walk_time = max_walk_time,
                                  time_window = time_window,
                                  percentiles = percentiles,
                                  progress = TRUE)

travel_times_private$id <- as.numeric(travel_times_private$id)
merged_travel_times_private <- left_join(travel_times_private, orgpoints_within_boroughs_lon_lat[, c("id", "lon", "lat", "Population_sum")], by = "id")
merged_travel_times_private_sf <- st_as_sf(merged_travel_times_private, coords = c("lon", "lat"), crs = 4326)

ggplot() +
  geom_sf(data = london_boroughs, fill = "white", color = "black") +  # 绘制伦敦区
  geom_sf(data = merged_travel_times_private_sf, aes(color = accessibility), alpha = 0.7) +  # 叠加点数据
  scale_color_gradientn(colors = c("lightgray", "deeppink", "blue"), 
                        values = scales::rescale(c(0, 5, 10)), 
                        limits = c(0, 10), 
                        breaks = c(0, 2, 4, 6, 8, 10),
                        labels = c("0", "2", "4", "6", "8", "10")) +  
  labs(title = "private schools' Accessibility Mapped onto London Boroughs",
       color = "Accessibility") +
  theme_minimal()
```

## 最短时间（但失败
```{r}
travel_time_cutoff <- c(0, 1, 2, 5, 10, 20, 30)

travel_times_priva_2 <- accessibility(r5r_core,
                        origins = orgpoints_within_boroughs,
                        destinations = private_destpoints,
                        mode = mode2,
                        opportunities_colnames = c("pos_accuracy"),
                        decay_function = "step",
                        cutoffs = travel_time_cutoff,
                        departure_datetime = departure_datetime,
                        max_walk_time = max_walk_time,
                        time_window = time_window,
                        percentiles = percentiles,
                        progress = TRUE)


travel_times_df <- as.data.frame(travel_times_priva_2)

# 找到到最近医院的最短旅行时间
travel_times_df$min_time <- apply(travel_times_df[, -1], 1, min, na.rm = TRUE)

travel_times_df$color <- cut(travel_times_df$min_time, 
                             breaks = c(0, 1, 2, 5, 10, 20, 30, 40),
                             labels = c("0", "1", "2", "5", "10", "20", "30", "40"))

result <- merge(orgpoints_within_boroughs, travel_times_df, by.x = "id", by.y = "id")


travel_times_priva_2$id <- as.numeric(travel_times_priva_2$id)
merged_travel_times_priva_2 <- left_join(travel_times_priva_2, orgpoints_within_boroughs_lon_lat[, c("id", "lon", "lat", "Population_sum")], by = "id")
merged_travel_times_priva_2_sf <- st_as_sf(merged_travel_times_priva_2, coords = c("lon", "lat"), crs = 4326)

ggplot() +
  geom_sf(data = london_boroughs, fill = "white", color = "black") +  # 绘制伦敦区
  geom_sf(data = result, aes(color = accessibility), alpha = 0.7) +  # 叠加点数据
  scale_color_gradientn(
    colors = c("lightgray", "pink", "orange", "yellow", "deeppink", "purple", "red"), 
    values = scales::rescale(c(0, 1, 2, 5, 10, 20, 30, 40)), 
    limits = c(0, 40), 
    breaks = c(0, 1, 2, 5, 10, 20, 30, 40),
    labels = c("0", "1", "2", "5", "10", "20", "30", "40")
  ) +  
  labs(title = "Private Schools' Accessibility Mapped onto London Boroughs",
       color = "Accessibility (minutes)") +
  theme_minimal() +
  theme(legend.key.height = unit(1, "cm"))  # 调整图例高度


```

##用于后续分析的，计算每个borough中
1.各Borough人口
2.平均可达性

pri 13 walk
```{r}

rm(bor_merged_travel_times_primary_sf)
bor_merged_travel_times_primary_sf <- st_join(merged_travel_times_primary_sf, london_boroughs["NAME"])

# Calculate the average of the points and accessibility in each Borough
borough_summary <- bor_merged_travel_times_primary_sf %>%
  st_drop_geometry() %>%  
  group_by(NAME) %>%  
  summarise(
    count =n(),
    pri_walk_mean_accessibility = mean(accessibility, na.rm = TRUE)
  )

london_boroughs <- london_boroughs %>%
  left_join(borough_summary, by = "NAME")
```


以上对于primary 13分钟 walk可达性来说，平均交通可达性最高的三个borough是Islington，Tower Hamlets,	
Hackney。（找一下有没有资料显示他们交通很发达之类的）


pri 13 car
```{r}
rm(bor_merged_travel_times_primary_car_sf)

bor_merged_travel_times_primary_car_sf <- st_join(merged_travel_times_primary_car_sf, london_boroughs["NAME"])

# Calculate the average of the points and accessibility in each Borough
borough_summary <- bor_merged_travel_times_primary_car_sf %>%
  st_drop_geometry() %>%  
  group_by(NAME) %>%  
  summarise(
    pri_car_mean_accessibility = mean(accessibility, na.rm = TRUE)
    
  )

london_boroughs <- london_boroughs %>%
  left_join(borough_summary, by = "NAME")
```


sec 25 walk
```{r}
rm(bor_merged_travel_times_secondary_walk_sf)

bor_merged_travel_times_secondary_walk_sf <- st_join(merged_travel_times_secondary_walk_sf, london_boroughs["NAME"])

# Calculate the average of the points and accessibility in each Borough
borough_summary <- bor_merged_travel_times_secondary_walk_sf %>%
  st_drop_geometry() %>%  
  group_by(NAME) %>%  
  summarise(
    sec_walk_mean_accessibility = mean(accessibility, na.rm = TRUE)

  )

london_boroughs <- london_boroughs %>%
  left_join(borough_summary, by = "NAME")

```


sec 25 car
```{r}
rm(bor_merged_travel_times_secondary_car_sf)

bor_merged_travel_times_secondary_car_sf <- st_join(merged_travel_times_secondary_car_sf, london_boroughs["NAME"])

# Calculate the average of the points and accessibility in each Borough
borough_summary <- bor_merged_travel_times_secondary_car_sf %>%
  st_drop_geometry() %>%  
  group_by(NAME) %>%  
  summarise(
    sec_car_mean_accessibility = mean(accessibility, na.rm = TRUE)

  )

london_boroughs <- london_boroughs %>%
  left_join(borough_summary, by = "NAME")
```



sec 25 walk+bus
```{r}
rm(bor_merged_travel_times_secondary_walk_bus_sf)

bor_merged_travel_times_secondary_walk_bus_sf <- st_join(merged_travel_times_secondary_walk_bus_sf, london_boroughs["NAME"])

# Calculate the average of the points and accessibility in each Borough
borough_summary <- bor_merged_travel_times_secondary_walk_bus_sf %>%
  st_drop_geometry() %>%  
  group_by(NAME) %>%  
  summarise(
    sec_walk_bus_mean_accessibility = mean(accessibility, na.rm = TRUE)
  )

london_boroughs <- london_boroughs %>%
  left_join(borough_summary, by = "NAME")
```



private 13 walk
```{r}
rm(bor_merged_travel_times_private_sf)

bor_merged_travel_times_private_sf <- st_join(merged_travel_times_private_sf, london_boroughs["NAME"])

# Calculate the average of the points and accessibility in each Borough
borough_summary <- bor_merged_travel_times_private_sf %>%
  st_drop_geometry() %>%  
  group_by(NAME) %>%  
  summarise(
    private_walk_mean_accessibility = mean(accessibility, na.rm = TRUE)

  )

london_boroughs <- london_boroughs %>%
  left_join(borough_summary, by = "NAME")
```



```{r}

# 假设 london_boroughs 是你的数据框，按 private_walk_mean_accessibility 从大到小排序
london_boroughs <- london_boroughs %>%
  arrange(desc(private_walk_mean_accessibility))

# 画柱状图
ggplot(london_boroughs, aes(x = reorder(NAME, -private_walk_mean_accessibility), y = private_walk_mean_accessibility)) +
  geom_col(fill = "skyblue", color = "black") +
  labs(title = "Private School 各 Borough 平均可达性",
       x = "Borough Name",
       y = "Mean Accessibility") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # 旋转x轴标签
```
private school的可达性，Kensington and Chelsea遥遥领先。


```{r}
# 按accessibility分组，并累加Population_sum
grouped_data_private <- bor_merged_travel_times_private_sf %>%
  group_by(accessibility) %>%
  summarize(total_population = sum(Population_sum, na.rm = TRUE))

# 绘制折线图
ggplot(grouped_data, aes(x = accessibility, y = total_population)) +
  geom_line() +
  geom_point() +
  labs(title = "The Relationship Between Total Population and Private School Accessibility",
       x = "Accessibility (Private School Accessibility)",
       y = "Total Population") +
  theme_minimal()

# 计算 accessibility 为 0 的行的 Population_sum 值的总和
zero_accessibility_population_sum <- sum(bor_merged_travel_times_private_sf$Population_sum[bor_merged_travel_times_private_sf$accessibility > 4], na.rm = TRUE)

# 计算所有行的 Population_sum 值的总和
total_population_sum <- sum(bor_merged_travel_times_private_sf$Population_sum, na.rm = TRUE)

# 计算百分比
percentage_zero_accessibility_population <- (zero_accessibility_population_sum / total_population_sum) * 100

# 输出结果
cat("accessibility 为 0 的行的 Population_sum 值累加占全部人口的百分比为：", percentage_zero_accessibility_population, "%\n")
```
可以看出私立学校的可达性对大部分人口来说很低，76.26293 %的伦敦人口的私立学校可达性为0.而只有1.538975 %的人能够在13分钟步行时间内可达大于4所私人学校。





加入borough数据，通过了GCSE考试的（获得中学文凭的）
```{r}
highest_qual <- read_csv("Data/Highest_qualification_levels.csv", na=c(" "))

colnames(highest_qual) <- str_replace_all(colnames(highest_qual), " ", "_")

highest_qual <- highest_qual %>% select(1:8)
# 假设 highest_qual 是你的数据框
highest_qual <- highest_qual %>%
  mutate(
    Proportion_with_no_qualifications = as.numeric(str_replace(Proportion_with_no_qualifications, "%", "")),
    Proportion_with_GCSE_grades_A_C_or_equivalent = as.numeric(str_replace(Proportion_with_GCSE_grades_A_C_or_equivalent, "%", "")),
    Proportion_with_GCE_A_level_or_equivalent = as.numeric(str_replace(Proportion_with_GCE_A_level_or_equivalent, "%", "")),
    Proportion_with_higher_education = as.numeric(str_replace(Proportion_with_higher_education, "%", "")),
    Proportion_with_a_degree_or_equivalent = as.numeric(str_replace(Proportion_with_a_degree_or_equivalent, "%", "")),
    Proportion_with_other_qualifications = as.numeric(str_replace(Proportion_with_other_qualifications, "%", ""))
  )

highest_qual <- highest_qual %>%
  mutate(Proportion_with_GCSE_grades_A_C_or_equivalent_and_higher = rowSums(select(., 4:8), na.rm = TRUE))


```


```{r}
london_boroughs <- london_boroughs %>%
  left_join(highest_qual %>% 
              select(London_borough, Proportion_with_GCSE_grades_A_C_or_equivalent_and_higher),
            by = c("NAME" = "London_borough"))

write.csv(london_boroughs, "Data/london_boroughs.csv", row.names = FALSE)

```

try
```{r}
london_boroughs_try <- london_boroughs %>%
  left_join(highest_qual %>% 
              select(London_borough, Proportion_with_GCSE_grades_A_C_or_equivalent),
            by = c("NAME" = "London_borough"))
london_boroughs_try<- london_boroughs_try%>%
  filter(Proportion_with_GCSE_grades_A_C_or_equivalent != 0 )
```

分析：
```{r}
#colnames(london_boroughs)

#不修改london_boroughs表
london_boroughs_hist <- london_boroughs

london_boroughs_hist$NAME <- gsub(" ", "_", london_boroughs_hist$NAME)

selected_columns <- london_boroughs_hist[, c("count",
                                        "pri_walk_mean_accessibility",
                                        "pri_car_mean_accessibility",
                                        "sec_walk_mean_accessibility",
                                        "sec_car_mean_accessibility",
                                        "private_walk_mean_accessibility",
                                        "sec_walk_bus_mean_accessibility",                                        "Proportion_with_GCSE_grades_A_C_or_equivalent_and_higher",                                        "median_of_house_price_2017")]

for (column in selected_columns) {
  # 绘制直方图
  p <- ggplot(london_boroughs_hist, aes_string(x = column)) +
    geom_histogram(binwidth = 5, fill = "blue", color = "black") +
    labs(title = paste("Histogram of", column),
         x = column,
         y = "Frequency")
  print(p)
  
  # 绘制箱线图
  p <- ggplot(london_boroughs_hist, aes_string(y = column)) +
    geom_boxplot(fill = "blue") +
    labs(title = paste("Boxplot of", column),
         y = column)
  print(p)
}
```


一元线性回归
```{r}
Regressiondata_GCSE_level<- london_boroughs_try%>%
  dplyr::select(sec_walk_bus_mean_accessibility, 
                Proportion_with_GCSE_grades_A_C_or_equivalent)

#I found that the unit of the density variable is "Units: [1/m^2] num," while the unit of another variable is "num." This caused an error in the calculation (specifically, 'Error in Ops.units'). To resolve this issue, I converted the density variable to a numeric format.
#Regressiondata <- Regressiondata %>%
 # mutate(density = as.numeric(density))

#now model
model_edu <- Regressiondata_GCSE_level %>%
  lm(sec_walk_bus_mean_accessibility ~ Proportion_with_GCSE_grades_A_C_or_equivalent,
     data=.)

library(broom)
#obtain coefficient statistics
tidy(model_edu)
glance(model_edu)


```





房价
```{r}
house_price <- read_csv("Data/house_prices.csv", na=c(" "))
house_price<- house_price%>%
  clean_names()

london_boroughs <- london_boroughs %>%
  left_join(house_price %>% 
              select(area, median_of_house_price_2017),
            by = c("NAME" = "area"))
```



```{r}
Regressiondata_hou_pri<- london_boroughs%>%
  dplyr::select(private_walk_mean_accessibility, 
                median_of_house_price_2017)

#I found that the unit of the density variable is "Units: [1/m^2] num," while the unit of another variable is "num." This caused an error in the calculation (specifically, 'Error in Ops.units'). To resolve this issue, I converted the density variable to a numeric format.
#Regressiondata <- Regressiondata %>%
 # mutate(density = as.numeric(density))

#now model
model_house <- Regressiondata_hou_pri %>%
  lm(private_walk_mean_accessibility ~ median_of_house_price_2017,
     data=.)

library(broom)
#obtain coefficient statistics
tidy(model_house)
glance(model_house)
```



```{r}
# 绘制散点图并添加回归线
ggplot(Regressiondata_hou_pri, aes(x = median_of_house_price_2017, y = private_walk_mean_accessibility)) +
  geom_point(color = "blue") +  # 绘制散点
  geom_smooth(method = "lm", color = "red") +  # 添加回归线
  labs(title = "Scatter Plot with Regression Line",
       x = "Median House Price 2017",
       y = "Private Walk Mean Accessibility") +
  theme_minimal()

# 提取残差
residuals <- residuals(model_house)

# 残差图
ggplot(Regressiondata_hou_pri, aes(x = median_of_house_price_2017, y = residuals)) +
  geom_point(color = "blue") +
  geom_hline(yintercept = 0, color = "red") +
  labs(title = "Residual Plot",
       x = "Median House Price 2017",
       y = "Residuals") +
  theme_minimal()


# Q-Q图
qqnorm(residuals)
qqline(residuals, col = "red")

# Shapiro-Wilk正态性检验
shapiro.test(residuals)

```
正态性检验用于检查残差是否符合正态分布。使用Q-Q图


```{r}
Regressiondata_hou_sec<- london_boroughs%>%
  dplyr::select(sec_walk_bus_mean_accessibility, 
                median_of_house_price_2017)

#I found that the unit of the density variable is "Units: [1/m^2] num," while the unit of another variable is "num." This caused an error in the calculation (specifically, 'Error in Ops.units'). To resolve this issue, I converted the density variable to a numeric format.
#Regressiondata <- Regressiondata %>%
 # mutate(density = as.numeric(density))

#now model
model_house2 <- Regressiondata_hou_sec %>%
  lm(sec_walk_bus_mean_accessibility ~ median_of_house_price_2017,
     data=.)

library(broom)
#obtain coefficient statistics
tidy(model_house2)
glance(model_house2)
```





```{r}
# 假设 london_boroughs 是你的数据框，按 private_walk_mean_accessibility 从大到小排序
london_boroughs <- london_boroughs %>%
  arrange(desc(private_walk_mean_accessibility))

# 画柱状图
ggplot(london_boroughs, aes(x = reorder(NAME, -private_walk_mean_accessibility), y = private_walk_mean_accessibility)) +
  geom_col(fill = "skyblue", color = "black") +
  labs(title = "Private School mean accessibility",
       x = "Borough Name",
       y = "Mean Accessibility") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5)  # 让标题居中
        )  # 旋转x轴标签
```



